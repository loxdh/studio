/**
 * Core Philosophy: This ruleset implements a Role-Based Access Control (RBAC) model
 * for an e-commerce platform. The core principle is that all content (products,
 * categories, blog articles) is publicly readable by anyone, but can only be
 * created, modified, or deleted by authenticated users who have an "admin" role.
 *
 * Data Structure: The data is organized into flat, top-level collections for
 * `products`, `categories`, and `blog_articles`. A dedicated `/roles_admin`
 * collection is used to manage authorization.
 *
 * Key Security Decisions:
 * - Public Read-Only Access: All primary content collections are open for read
 *   and list operations to support anonymous browsing of the e-commerce site.
 * - Admin-Guarded Writes: All write operations (`create`, `update`, `delete`)
 *   on content collections are strictly limited to admin users.
 * - Role-Based Authorization: A user is considered an admin if a document with
 *   their UID exists in the `/roles_admin` collection. This avoids costly lookups
 *   and keeps authorization logic simple and performant.
 * - Admin Management: The `/roles_admin` collection itself is protected,
 *   allowing only existing admins to view or manage the list of other admins.
 *   This prevents unauthorized privilege escalation. Initial admin users must be
 *   added via the Firebase Console or a trusted backend script.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user has an admin role.
     * An admin is defined by the existence of a document in the /roles_admin
     * collection where the document ID matches the user's UID.
     * This check is fast and efficient as it only verifies existence.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * Ensures that a state-changing operation (update, delete) is being
     * performed on a document that actually exists.
     */
    function isExistingDoc() {
      return resource != null;
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Controls access to the products collection.
     *   Products are publicly visible to all users, but only admins can
     *   create, update, or delete them.
     * @path /products/{productId}
     * @allow (get) Any user, signed in or not, can view a single product.
     * @deny (create) A non-admin user cannot create a new product.
     * @principle Implements a "Public Read, Admin-Only Write" access pattern.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && isExistingDoc();
      allow delete: if isAdmin() && isExistingDoc();
    }

    /**
     * @description Controls access to the categories collection.
     *   Categories are publicly visible, allowing users to browse products by
     *   category, but only admins can manage the category list.
     * @path /categories/{categoryId}
     * @allow (list) Any user, signed in or not, can list all categories.
     * @deny (delete) An authenticated but non-admin user cannot delete a category.
     * @principle Implements a "Public Read, Admin-Only Write" access pattern.
     */
    match /categories/{categoryId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && isExistingDoc();
      allow delete: if isAdmin() && isExistingDoc();
    }

    /**
     * @description Controls access to the blog articles collection.
     *   Blog articles are public content for all site visitors. Write access
     *   is restricted to admins for content management.
     * @path /blog_articles/{blogArticleId}
     * @allow (get) Any user can read a blog article.
     * @deny (update) A non-admin user cannot edit an existing blog article.
     * @principle Implements a "Public Read, Admin-Only Write" access pattern.
     */
    match /blog_articles/{blogArticleId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && isExistingDoc();
      allow delete: if isAdmin() && isExistingDoc();
    }

    /**
     * @description Secures the admin role management collection.
     *   This collection is the source of truth for admin privileges. Only
     *   existing admins are allowed to see who the other admins are or to
     *   grant/revoke admin status.
     * @path /roles_admin/{userId}
     * @allow (create) An existing admin can create a document to make another user an admin.
     * @deny (get) A regular user cannot check if another user is an admin.
     * @deny (list) The list of admins is not public to prevent user enumeration.
     * @principle Protects the authorization mechanism itself from unauthorized access
     *   and modification, preventing privilege escalation.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && isExistingDoc();
      allow delete: if isAdmin() && isExistingDoc();
    }
  }
}